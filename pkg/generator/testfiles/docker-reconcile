#!/bin/bash

mkdir -p '/var/lib/kubelet'
cat << EOF | base64 -d > '/var/lib/kubelet/ca.crt'
c2VjcmV0UmVmOgpuYW1lOiBkZWZhdWx0LXRva2VuLWQ5bnpsCmRhdGFLZXk6IHRva2Vu
EOF
chmod '0644' '/var/lib/kubelet/ca.crt'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/configure_cgroups.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKQ0dST1VQX0NNRExJTkU9Ii9ldGMva2VybmVsL2NtZGxpbmUuZC84MC1jZ3JvdXAuY2ZnIgpSRVNUQVJUX0NPTlRST0xfRklMRT0iL3Zhci9ydW4vZ2FyZGVuZXIvcmVzdGFydC1yZXF1aXJlZCIKCmZ1bmN0aW9uIGdldF9mc19vZl9kaXJlY3RvcnkgewogICAgWyAteiAiJDEiIC1vICEgLWQgIiQxIiBdICYmIHJldHVybgogICAgZWNobyAtbiAiJChzdGF0IC1jICVUIC1mICIkMSIpIgp9CgpmdW5jdGlvbiBjaGVja19jdXJyZW50X2Nncm91cCB7CiAgICAjIGRldGVybWluaW5nIGlmIHRoZSBzeXN0ZW0gaXMgcnVubmluZyBjZ3JvdXB2MSBvciBjZ3JvdXB2MgogICAgIyB1c2luZyBzeXN0ZW1kIGFwcHJvYWNoIGFzIGluCiAgICAjIGh0dHBzOi8vZ2l0aHViLmNvbS9zeXN0ZW1kL3N5c3RlbWQvYmxvYi9kNmQ0NTAwNzRmZjc3MjlkNDM0NzY4MDRlMGUxOWMwNDljMDMxNDFkL3NyYy9iYXNpYy9jZ3JvdXAtdXRpbC5jI0wyMTA1LUwyMTQ5CgogICAgQ0dST1VQX0lEPSJjZ3JvdXBmcyIKICAgIENHUk9VUDJfSUQ9ImNncm91cDJmcyIKICAgIFRNUEZTX0lEPSJ0bXBmcyIKCiAgICBjZ3JvdXBfZGlyX2ZzPSIkKGdldF9mc19vZl9kaXJlY3RvcnkgL3N5cy9mcy9jZ3JvdXApIgoKICAgIGlmIFtbICIkY2dyb3VwX2Rpcl9mcyIgPT0gIiRDR1JPVVAyX0lEIiBdXTsgdGhlbgogICAgICAgIGVjaG8gInYyIgogICAgICAgIHJldHVybgogICAgZWxpZiBbWyAiJGNncm91cF9kaXJfZnMiID09ICIkVE1QRlNfSUQiIF1dOyB0aGVuCiAgICAgICAgaWYgW1sgIiQoZ2V0X2ZzX29mX2RpcmVjdG9yeSAvc3lzL2ZzL2Nncm91cC91bmlmaWVkKSIgPT0gIiRDR1JPVVAyX0lEIiBdXTsgdGhlbgogICAgICAgICAgICBlY2hvICJ2MSAoY2dyb3VwdjJzeXN0ZW1kKSIKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZmkKICAgICAgICBpZiBbWyAiJChnZXRfZnNfb2ZfZGlyZWN0b3J5IC9zeXMvZnMvY2dyb3VwL3N5c3RlbWQpIiA9PSAiJENHUk9VUDJfSUQiIF1dOyB0aGVuCiAgICAgICAgICAgIGVjaG8gInYxIChjZ3JvdXB2MnN5c3RlbWQyMzIpIgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmaQogICAgICAgIGlmIFtbICIkKGdldF9mc19vZl9kaXJlY3RvcnkgL3N5cy9mcy9jZ3JvdXAvc3lzdGVtZCkiID09ICIkQ0dST1VQX0lEIiBdXTsgdGhlbgogICAgICAgICAgICBlY2hvICJ2MSIKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZmkKICAgIGZpCiAgICAjIGlmIHdlIGNhbWUgdGhpcyBmYXIgZGVzcGl0ZSBhbGwgdGhvc2UgcmV0dXJucywgaXQgbWVhbnMgc29tZXRoaW5nIHdlbnQgd3JvbmcKICAgIGVjaG8gImZhaWxlZCB0byBkZXRlcm1pbmUgY2dyb3VwIHZlcnNpb24gZm9yIHRoaXMgc3lzdGVtIiA+JjIKICAgIGV4aXQgMQp9CgojIHRoZXNlIGFyZSB0aGUgY2dyb3VwIHZlcnNpb25zIHdlIHdhbnQgdG8gaGF2ZSBjb25maWd1cmVkIGFuZCB0aGF0IGFyZSBhY3R1YWxseSBydW5uaW5nIG9uIHRoZSBzeXN0ZW0KZGVzaXJlZF9jZ3JvdXA9InYyIgpjdXJyZW50X2Nncm91cD0kKGNoZWNrX2N1cnJlbnRfY2dyb3VwKQoKIyBjaGVjayBpZiB0aGUgc3lzdGVtIG5lZWRzIHRvIGJlIHJlY29uZmlndXJlZAppZiBbWyAiJGRlc2lyZWRfY2dyb3VwIiA9PSAiJHtjdXJyZW50X2Nncm91cCUlICp9IiBdXTsgdGhlbgogICAgZWNobyAic3lzdGVtIGFscmVhZHkgcnVubmluZyB3aXRoIGNncm91cCAkZGVzaXJlZF9jZ3JvdXAgLSBleGl0aW5nIgogICAgZXhpdCAwCmZpCgojIHJlY29uZmlndXJlIHRoZSBib290bG9hZGVyIHRvIGluY2x1ZGUgdW5pZmllZCBoaWVyYXJjaHkgKG9yIG5vdCkKaWYgW1sgIiRkZXNpcmVkX2Nncm91cCIgPT0gInYxIiBdXTsgdGhlbgogICAgZWNobyAiY29uZmlndXJpbmcgc3lzdGVtIHRvIHVzZSBjZ3JvdXAgdjEiCiAgICBjYXQgPDwgJ19fRU9GJyA+ICIkQ0dST1VQX0NNRExJTkUiCiMgRGlzYWJsZSBjZ3JvdXAgdjIgc3VwcG9ydApDTURMSU5FX0xJTlVYPSIkQ01ETElORV9MSU5VWCBzeXN0ZW1kLnVuaWZpZWRfY2dyb3VwX2hpZXJhcmNoeT0wIgpfX0VPRgoKZWxpZiBbWyAiJGRlc2lyZWRfY2dyb3VwIiA9PSAidjIiIF1dOyB0aGVuCiAgICBlY2hvICJjb25maWd1cmluZyBzeXN0ZW0gdG8gdXNlIGNncm91cCB2MiIKICAgIGNhdCA8PCAnX19FT0YnID4gIiRDR1JPVVBfQ01ETElORSIKIyBFbmFibGUgY2dyb3VwIHYyIHN1cHBvcnQKQ01ETElORV9MSU5VWD0iJENNRExJTkVfTElOVVggc3lzdGVtZC51bmlmaWVkX2Nncm91cF9oaWVyYXJjaHk9MSIKX19FT0YKCmVsc2UKICAgIGVjaG8gImRlc2lyZWQgY2dyb3VwIHZlcnNpb24gJGRlc2lyZWRfY2dyb3VwIGNhbm5vdCBiZSBlbmFibGVkLCBsZWF2aW5nIHN5c3RlbSB3aXRoICRjdXJyZW50X2Nncm91cCIKICAgIGV4aXQgMQpmaQoKIyB1cGRhdGUgYm9vdGxvYWRlcgovdXNyL2xvY2FsL3NiaW4vdXBkYXRlLXN5c2xpbnV4CgojIHRyaWdnZXIgYSByZWJvb3QgYnkgcGxhY2luZyBhIGNvbnRyb2wgZmlsZSBpbnRvIC92YXIvcnVuIHdoaWNoIHdpbGwgYmUgcGlja2VkIHVwIGJ5CiMgZ2FyZGVuZXItcmVzdGFydC1zeXN0ZW0uc2VydmljZQplY2hvICJzY2hlZHVsaW5nIGEgcmVib290IHRvIGFjdGl2YXRlIGNncm91cCAkZGVzaXJlZF9jZ3JvdXAiCm1rZGlyIC1wICQoZGlybmFtZSAkUkVTVEFSVF9DT05UUk9MX0ZJTEUpCnRvdWNoICRSRVNUQVJUX0NPTlRST0xfRklMRQo=
EOF
chmod '0755' '/opt/gardener/bin/configure_cgroups.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/configure_lsm.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKTFNNX0NNRExJTkU9Ii9ldGMva2VybmVsL2NtZGxpbmUuZC85MC1sc20uY2ZnIgpSRVNUQVJUX0NPTlRST0xfRklMRT0iL3Zhci9ydW4vZ2FyZGVuZXIvcmVzdGFydC1yZXF1aXJlZCIKCmZ1bmN0aW9uIGNoZWNrX2N1cnJlbnRfbHNtIHsKICAgIGlmIGdyZXAgLXEgc2VsaW51eCAvc3lzL2tlcm5lbC9zZWN1cml0eS9sc207IHRoZW4KICAgICAgICBlY2hvIFNFTGludXgKICAgIGVsaWYgZ3JlcCAtcSBhcHBhcm1vciAvc3lzL2tlcm5lbC9zZWN1cml0eS9sc207IHRoZW4KICAgICAgICBlY2hvIEFwcEFybW9yCiAgICBlbHNlCiAgICAgICAgZWNobyBub25lCiAgICBmaQp9CgpkZXNpcmVkX2xzbT1BcHBBcm1vcgpjdXJyZW50X2xzbT0kKGNoZWNrX2N1cnJlbnRfbHNtKQoKaWYgW1sgIiRkZXNpcmVkX2xzbSIgPT0gIkFwcEFybW9yIiBdXTsgdGhlbgogICAgZWNobyAiY29uZmlndXJpbmcgc3lzdGVtIHRvIHVzZSBBcHBBcm1vciBhcyBsc20iCiAgICBjYXQgPDwgJ19fRU9GJyA+ICIkTFNNX0NNRExJTkUiCiMgU2V0IEFwcEFybW9yIGFzIExpbnV4IFNlY3VyaXR5IE1vZHVsZQpDTURMSU5FX0xJTlVYPSIkQ01ETElORV9MSU5VWCBzZWN1cml0eT1hcHBhcm1vciIKX19FT0YKCmVsaWYgW1sgIiRkZXNpcmVkX2xzbSIgPT0gIlNFTGludXgiIF1dOyB0aGVuCiAgICBlY2hvICJjb25maWd1cmluZyBzeXN0ZW0gdG8gdXNlIFNFTGludXggYXMgbHNtIgogICAgY2F0IDw8ICdfX0VPRicgPiAiJExTTV9DTURMSU5FIgojIFNldCBTRUxpbnV4IGFzIExpbnV4IFNlY3VyaXR5IE1vZHVsZQpDTURMSU5FX0xJTlVYPSIkQ01ETElORV9MSU5VWCBzZWN1cml0eT1zZWxpbnV4IgpfX0VPRgoKZWxzZQogICAgZWNobyAiZGVzaXJlZCBsc20gJGRlc2lyZWRfbHNtIGNhbm5vdCBiZSBlbmFibGVkLCBsZWF2aW5nIHN5c3RlbSB3aXRoICRjdXJyZW50X2xzbSIKICAgIGV4aXQgMQpmaQoKIyB1cGRhdGUgYm9vdGxvYWRlcgovdXNyL2xvY2FsL3NiaW4vdXBkYXRlLXN5c2xpbnV4CgppZiBbWyAiJGRlc2lyZWRfbHNtIiA9PSAiJHtjdXJyZW50X2xzbX0iIF1dOyB0aGVuCiAgICBlY2hvICJzeXN0ZW0gYWxyZWFkeSBydW5uaW5nIHdpdGggJGRlc2lyZWRfbHNtIC0gbm90IHRyaWdnZXJpbmcgYSByZWJvb3QiCiAgICBleGl0IDAKZWxzZQogICAgZWNobyAic2NoZWR1bGluZyBhIHJlYm9vdCB0byBMaW51eCBzZWN1cml0eSBtb2R1bGUgJGRlc2lyZWRfbHNtIgogICAgbWtkaXIgLXAgJChkaXJuYW1lICRSRVNUQVJUX0NPTlRST0xfRklMRSkKICAgIHRvdWNoICRSRVNUQVJUX0NPTlRST0xfRklMRQpmaQ==
EOF
chmod '0755' '/opt/gardener/bin/configure_lsm.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/configure_netfilter_backend.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKZnVuY3Rpb24gY2hlY2tfbmV0ZmlsdGVyX2JhY2tlbmQgewogICAgIyB0YWtlbiBmcm9tIEt1YmVybmV0ZXMKICAgICMgaHR0cHM6Ly9naXRodWIuY29tL2t1YmVybmV0ZXMva3ViZXJuZXRlcy9ibG9iLzYyM2I2OTc4ODY2YjVkMzc5MGQxN2ZmMTM2MDFlZjllN2U0ZjRiZjAvYnVpbGQvZGViaWFuLWlwdGFibGVzL2lwdGFibGVzLXdyYXBwZXIjTDI4LUwzOAogICAgbnVtX2xlZ2FjeV9saW5lcz0kKCAoaXB0YWJsZXMtbGVnYWN5LXNhdmUgfHwgdHJ1ZTsgaXA2dGFibGVzLWxlZ2FjeS1zYXZlIHx8IHRydWUpIDI+L2Rldi9udWxsIHwgZ3JlcCAnXi0nIHwgd2MgLWwpCiAgICBpZiBbICIke251bV9sZWdhY3lfbGluZXN9IiAtZ2UgMTAgXTsgdGhlbgogICAgICAgIG1vZGU9bGVnYWN5CiAgICBlbHNlCiAgICAgICAgbnVtX25mdF9saW5lcz0kKCAodGltZW91dCA1IHNoIC1jICJpcHRhYmxlcy1uZnQtc2F2ZTsgaXA2dGFibGVzLW5mdC1zYXZlIiB8fCB0cnVlKSAyPi9kZXYvbnVsbCB8IGdyZXAgJ14tJyB8IHdjIC1sKQogICAgICAgIGlmIFsgIiR7bnVtX2xlZ2FjeV9saW5lc30iIC1nZSAiJHtudW1fbmZ0X2xpbmVzfSIgXTsgdGhlbgogICAgICAgICAgICBtb2RlPWxlZ2FjeQogICAgICAgIGVsc2UKICAgICAgICAgICAgbW9kZT1uZnQKICAgICAgICBmaQogICAgZmkKICAgIGVjaG8gJG1vZGUKfQoKZGVzaXJlZF9uZmI9bmZ0YWJsZXMKCmlmIFsgIiRkZXNpcmVkX25mYiIgPT0gImlwdGFibGVzIiAtbyAiJGRlc2lyZWRfbmZiIiA9PSAibGVnYWN5IiBdOyB0aGVuCiAgICBlY2hvICJjb25maWd1cmluZyBuZXRmaWx0ZXIgYmFja2VuZCB0byBpcHRhYmxlcy1sZWdhY3kiCiAgICBuZl9iYWNrZW5kPSIvdXNyL3NiaW4vaXB0YWJsZXMtbGVnYWN5IgogICAgbmY2X2JhY2tlbmQ9Ii91c3Ivc2Jpbi9pcDZ0YWJsZXMtbGVnYWN5IgplbGlmIFsgIiRkZXNpcmVkX25mYiIgPT0gIm5mdGFibGVzIiAtbyAiJGRlc2lyZWRfbmZiIiA9PSAibmZ0IiBdOyB0aGVuCiAgICBlY2hvICJjb25maWd1cmluZyBuZXRmaWx0ZXIgYmFja2VuZCB0byBpcHRhYmxlcy1uZnQiCiAgICBuZl9iYWNrZW5kPSIvdXNyL3NiaW4vaXB0YWJsZXMtbmZ0IgogICAgbmY2X2JhY2tlbmQ9Ii91c3Ivc2Jpbi9pcDZ0YWJsZXMtbmZ0IgpmaQoKZm9yIG5mZiBpbiAkbmZfYmFja2VuZCAkbmY2X2JhY2tlbmQ7IGRvCiAgICBpZiBbICEgLXggIiRuZmYiIF07IHRoZW4KICAgICAgICBlY2hvICIkbmZmIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBleGVjdXRhYmxlIiA+JjIKICAgICAgICBleGl0IDEKICAgIGZpCmRvbmUKCnVwZGF0ZS1hbHRlcm5hdGl2ZXMgLS1zZXQgaXB0YWJsZXMgIiRuZl9iYWNrZW5kIiA+IC9kZXYvbnVsbAp1cGRhdGUtYWx0ZXJuYXRpdmVzIC0tc2V0IGlwNnRhYmxlcyAiJG5mNl9iYWNrZW5kIiA+IC9kZXYvbnVsbAo=
EOF
chmod '0755' '/opt/gardener/bin/configure_netfilter_backend.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/restart_system.sh'
IyEvYmluL2Jhc2gKClJFU1RBUlRfQ09OVFJPTF9GSUxFPSIvdmFyL3J1bi9nYXJkZW5lci9yZXN0YXJ0LXJlcXVpcmVkIgoKc2V0IC1FdW8gcGlwZWZhaWwKCmlmIHN5c3RlbWN0bCBzdGF0dXMga3ViZWxldC5zZXJ2aWNlOyB0aGVuCiAgICBlY2hvICJrdWJlbGV0IGlzIHJ1bm5pbmcsIG5vdCByZXN0YXJ0aW5nIHRoZSBrZXJuZWwiID4mMgogICAgZXhpdCAwCmZpCgppZiBbICEgLWUgIiRSRVNUQVJUX0NPTlRST0xfRklMRSIgXTsgdGhlbgogICAgZWNobyAicmVzdGFydCBvZiBrZXJuZWwgbm90IHJlcXVlc3RlZCwgZXhpdGluZyBoYXBwaWx5IgogICAgZXhpdCAwCmZpCgpzZXQgLWUKCmtlcm5lbD0iL2Jvb3Qvdm1saW51ei0kKHVuYW1lIC1yKSIKaW5pdHJkPSIvYm9vdC9pbml0cmQuaW1nLSQodW5hbWUgLXIpIgpjbWRsaW5lPSIvZXRjL2tlcm5lbC9jbWRsaW5lIgoKaWYgWyAhIC1lICIka2VybmVsIiBdOyB0aGVuCiAgICBlY2hvICJrZXJuZWwgY291bGQgbm90IGJlIGZvdW5kIGF0ICRrZXJuZWwiID4mMgogICAgZXhpdCAxCmZpCgppZiBbICEgLWUgIiRpbml0cmQiIF07IHRoZW4KICAgIGVjaG8gImtlcm5lbCBjb3VsZCBub3QgYmUgZm91bmQgYXQgJGluaXRyZCIgPiYyCiAgICBleGl0IDIKZmkKCmlmIFsgISAtZSAiJGNtZGxpbmUiIF07IHRoZW4KICAgIGVjaG8gImtlcm5lbCBjb21tYW5kIGxpbmUgY291bGQgbm90IGJlIGZvdW5kIGF0ICRjbWRsaW5lIiA+JjIKICAgIGV4aXQgMwpmaQoKIyB3ZSBzZWVtIHRvIGhhdmUgZXZlcnl0aGluZyBzbyBsZXRzIHJlc3RhcnQgdGhlIGtlcm5lbCB3aXRoIGtleGVjCnJtIC1mICIkUkVTVEFSVF9DT05UUk9MX0ZJTEUiCgojIGtleGVjIHdvdWxkIGJlIG5pY2UgYmVjYXVzZSBpdCBpcyBmYXN0IGJ1dCBhdCB0aGUgbW9tZW50LCBpdCBzZWVtcyB0byBiZSBmYWlsaW5nIG9uIHNvbWUKIyBzeXN0ZW1zIGR1ZSB0byBpbml0cmQgc2l6ZSBvciBhY3BpIG9yIHNvbWV0aGluZyBlbHNlLCBzbyBjb21tZW50aW5nIGl0IG91dCBmb3Igbm93CiNrZXhlYyAtYSAtLWluaXRyZD0iJGluaXRyZCIgLS1jb21tYW5kLWxpbmU9IlwiJChjYXQgIiRjbWRsaW5lIilcIiIgIiRrZXJuZWwiCgojIGFuZCByZWx5IG9uIGdvb2Qgb2xkIHNodXRkb3duIChldmVuIHRob3VnaCB0aGF0IG1heSB0YWtlIGFnZXMgb24gc3lzdGVtcyB3LyBsb3RzIG9mIHJhbSkKc2h1dGRvd24gLS1uby13YWxsIC1yIG5vdw==
EOF
chmod '0755' '/opt/gardener/bin/restart_system.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/containerd_cgroup_driver.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKZnVuY3Rpb24gZ2V0X2ZzX29mX2RpcmVjdG9yeSB7CiAgICBbIC16ICIkMSIgLW8gISAtZCAiJDEiIF0gJiYgcmV0dXJuCiAgICBlY2hvIC1uICIkKHN0YXQgLWMgJVQgLWYgIiQxIikiCn0KCmZ1bmN0aW9uIGNoZWNrX2N1cnJlbnRfY2dyb3VwIHsKICAgICMgZGV0ZXJtaW5pbmcgaWYgdGhlIHN5c3RlbSBpcyBydW5uaW5nIGNncm91cHYxIG9yIGNncm91cHYyCiAgICAjIHVzaW5nIHN5c3RlbWQgYXBwcm9hY2ggYXMgaW4KICAgICMgaHR0cHM6Ly9naXRodWIuY29tL3N5c3RlbWQvc3lzdGVtZC9ibG9iL2Q2ZDQ1MDA3NGZmNzcyOWQ0MzQ3NjgwNGUwZTE5YzA0OWMwMzE0MWQvc3JjL2Jhc2ljL2Nncm91cC11dGlsLmMjTDIxMDUtTDIxNDkKCiAgICBDR1JPVVBfSUQ9ImNncm91cGZzIgogICAgQ0dST1VQMl9JRD0iY2dyb3VwMmZzIgogICAgVE1QRlNfSUQ9InRtcGZzIgoKICAgIGNncm91cF9kaXJfZnM9IiQoZ2V0X2ZzX29mX2RpcmVjdG9yeSAvc3lzL2ZzL2Nncm91cCkiCgogICAgaWYgW1sgIiRjZ3JvdXBfZGlyX2ZzIiA9PSAiJENHUk9VUDJfSUQiIF1dOyB0aGVuCiAgICAgICAgZWNobyAidjIiCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIFtbICIkY2dyb3VwX2Rpcl9mcyIgPT0gIiRUTVBGU19JRCIgXV07IHRoZW4KICAgICAgICBpZiBbWyAiJChnZXRfZnNfb2ZfZGlyZWN0b3J5IC9zeXMvZnMvY2dyb3VwL3VuaWZpZWQpIiA9PSAiJENHUk9VUDJfSUQiIF1dOyB0aGVuCiAgICAgICAgICAgIGVjaG8gInYxIChjZ3JvdXB2MnN5c3RlbWQpIgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmaQogICAgICAgIGlmIFtbICIkKGdldF9mc19vZl9kaXJlY3RvcnkgL3N5cy9mcy9jZ3JvdXAvc3lzdGVtZCkiID09ICIkQ0dST1VQMl9JRCIgXV07IHRoZW4KICAgICAgICAgICAgZWNobyAidjEgKGNncm91cHYyc3lzdGVtZDIzMikiCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZpCiAgICAgICAgaWYgW1sgIiQoZ2V0X2ZzX29mX2RpcmVjdG9yeSAvc3lzL2ZzL2Nncm91cC9zeXN0ZW1kKSIgPT0gIiRDR1JPVVBfSUQiIF1dOyB0aGVuCiAgICAgICAgICAgIGVjaG8gInYxIgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmaQogICAgZmkKICAgICMgaWYgd2UgY2FtZSB0aGlzIGZhciBkZXNwaXRlIGFsbCB0aG9zZSByZXR1cm5zLCBpdCBtZWFucyBzb21ldGhpbmcgd2VudCB3cm9uZwogICAgZWNobyAiZmFpbGVkIHRvIGRldGVybWluZSBjZ3JvdXAgdmVyc2lvbiBmb3IgdGhpcyBzeXN0ZW0iID4mMgogICAgZXhpdCAxCn0KCiMgcmVjb25maWd1cmVzIGNvbnRhaW5lcmQgdG8gdXNlIHN5c3RlbWQgYXMgYSBjZ3JvdXAgZHJpdmVyIG9uIGNncm91cCB2MiBlbmFibGVkIHN5c3RlbXMKZnVuY3Rpb24gY29uZmlndXJlX2NvbnRhaW5lcmQgewogICAgZGVzaXJlZF9jZ3JvdXA9JDEKICAgIENPTlRBSU5FUkRfQ09ORklHPSIvZXRjL2NvbnRhaW5lcmQvY29uZmlnLnRvbWwiCgogICAgaWYgWyAhIC1lICIkQ09OVEFJTkVSRF9DT05GSUciIF07IHRoZW4KICAgICAgICBlY2hvICIkQ09OVEFJTkVSRF9DT05GSUcgZG9lcyBub3QgZXhpc3QiID4mMgogICAgICAgIHJldHVybgogICAgZmkKCiAgICBpZiBbWyAiJGRlc2lyZWRfY2dyb3VwIiA9PSAidjIiIF1dOyB0aGVuCiAgICAgICAgZWNobyAiQ29uZmlndXJpbmcgY29udGFpbmVyZCBjZ3JvdXAgZHJpdmVyIHRvIHN5c3RlbWQiCiAgICAgICAgc2VkIC1pICJzL1N5c3RlbWRDZ3JvdXAgKj0gKmZhbHNlL1N5c3RlbWRDZ3JvdXAgPSB0cnVlLyIgIiRDT05UQUlORVJEX0NPTkZJRyIKICAgIGVsc2UKICAgICAgICBlY2hvICJDb25maWd1cmluZyBjb250YWluZXJkIGNncm91cCBkcml2ZXIgdG8gY2dyb3VwZnMiCiAgICAgICAgc2VkIC1pICJzL1N5c3RlbWRDZ3JvdXAgKj0gKnRydWUvU3lzdGVtZENncm91cCA9IGZhbHNlLyIgIiRDT05UQUlORVJEX0NPTkZJRyIKICAgIGZpCn0KCmNvbmZpZ3VyZV9jb250YWluZXJkICIkKGNoZWNrX2N1cnJlbnRfY2dyb3VwKSIK
EOF
chmod '0755' '/opt/gardener/bin/containerd_cgroup_driver.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/kubelet_cgroup_driver.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKZnVuY3Rpb24gZ2V0X2ZzX29mX2RpcmVjdG9yeSB7CiAgICBbIC16ICIkMSIgLW8gISAtZCAiJDEiIF0gJiYgcmV0dXJuCiAgICBlY2hvIC1uICIkKHN0YXQgLWMgJVQgLWYgIiQxIikiCn0KCmZ1bmN0aW9uIGNoZWNrX2N1cnJlbnRfY2dyb3VwIHsKICAgICMgZGV0ZXJtaW5pbmcgaWYgdGhlIHN5c3RlbSBpcyBydW5uaW5nIGNncm91cHYxIG9yIGNncm91cHYyCiAgICAjIHVzaW5nIHN5c3RlbWQgYXBwcm9hY2ggYXMgaW4KICAgICMgaHR0cHM6Ly9naXRodWIuY29tL3N5c3RlbWQvc3lzdGVtZC9ibG9iL2Q2ZDQ1MDA3NGZmNzcyOWQ0MzQ3NjgwNGUwZTE5YzA0OWMwMzE0MWQvc3JjL2Jhc2ljL2Nncm91cC11dGlsLmMjTDIxMDUtTDIxNDkKCiAgICBDR1JPVVBfSUQ9ImNncm91cGZzIgogICAgQ0dST1VQMl9JRD0iY2dyb3VwMmZzIgogICAgVE1QRlNfSUQ9InRtcGZzIgoKICAgIGNncm91cF9kaXJfZnM9IiQoZ2V0X2ZzX29mX2RpcmVjdG9yeSAvc3lzL2ZzL2Nncm91cCkiCgogICAgaWYgW1sgIiRjZ3JvdXBfZGlyX2ZzIiA9PSAiJENHUk9VUDJfSUQiIF1dOyB0aGVuCiAgICAgICAgZWNobyAidjIiCiAgICAgICAgcmV0dXJuCiAgICBlbGlmIFtbICIkY2dyb3VwX2Rpcl9mcyIgPT0gIiRUTVBGU19JRCIgXV07IHRoZW4KICAgICAgICBpZiBbWyAiJChnZXRfZnNfb2ZfZGlyZWN0b3J5IC9zeXMvZnMvY2dyb3VwL3VuaWZpZWQpIiA9PSAiJENHUk9VUDJfSUQiIF1dOyB0aGVuCiAgICAgICAgICAgIGVjaG8gInYxIChjZ3JvdXB2MnN5c3RlbWQpIgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmaQogICAgICAgIGlmIFtbICIkKGdldF9mc19vZl9kaXJlY3RvcnkgL3N5cy9mcy9jZ3JvdXAvc3lzdGVtZCkiID09ICIkQ0dST1VQMl9JRCIgXV07IHRoZW4KICAgICAgICAgICAgZWNobyAidjEgKGNncm91cHYyc3lzdGVtZDIzMikiCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZpCiAgICAgICAgaWYgW1sgIiQoZ2V0X2ZzX29mX2RpcmVjdG9yeSAvc3lzL2ZzL2Nncm91cC9zeXN0ZW1kKSIgPT0gIiRDR1JPVVBfSUQiIF1dOyB0aGVuCiAgICAgICAgICAgIGVjaG8gInYxIgogICAgICAgICAgICByZXR1cm4KICAgICAgICBmaQogICAgZmkKICAgICMgaWYgd2UgY2FtZSB0aGlzIGZhciBkZXNwaXRlIGFsbCB0aG9zZSByZXR1cm5zLCBpdCBtZWFucyBzb21ldGhpbmcgd2VudCB3cm9uZwogICAgZWNobyAiZmFpbGVkIHRvIGRldGVybWluZSBjZ3JvdXAgdmVyc2lvbiBmb3IgdGhpcyBzeXN0ZW0iID4mMgogICAgZXhpdCAxCn0KCiMgcmVjb25maWd1cmUgdGhlIGt1YmVsZXQgdG8gdXNlIHN5c3RlbWQgYXMgYSBjZ3JvdXAgZHJpdmVyIG9uIGNncm91cCB2MiBlbmFibGVkIHN5c3RlbXMKZnVuY3Rpb24gY29uZmlndXJlX2t1YmVsZXQgewogICAgZGVzaXJlZF9jZ3JvdXA9JDEKICAgIEtVQkVMRVRfQ09ORklHPSIvdmFyL2xpYi9rdWJlbGV0L2NvbmZpZy9rdWJlbGV0IgoKICAgIGlmIFsgISAtZSAiJEtVQkVMRVRfQ09ORklHIiBdOyB0aGVuCiAgICAgICAgZWNobyAiJEtVQkVMRVRfQ09ORklHIGRvZXMgbm90IGV4aXN0IiA+JjIKICAgICAgICByZXR1cm4KICAgIGZpCgogICAgaWYgW1sgIiRkZXNpcmVkX2Nncm91cCIgPT0gInYyIiBdXTsgdGhlbgogICAgICAgIGVjaG8gIkNvbmZpZ3VyaW5nIGt1YmVsZXQgdG8gdXNlIHN5c3RlbWQgYXMgY2dyb3VwIGRyaXZlciIKICAgICAgICBzZWQgLWkgInMvY2dyb3VwRHJpdmVyOiBjZ3JvdXBmcy9jZ3JvdXBEcml2ZXI6IHN5c3RlbWQvIiAiJEtVQkVMRVRfQ09ORklHIgogICAgZWxzZQogICAgICAgIGVjaG8gIkNvbmZpZ3VyaW5nIGt1YmVsZXQgdG8gdXNlIGNncm91cGZzIGFzIGNncm91cCBkcml2ZXIiCiAgICAgICAgc2VkIC1pICJzL2Nncm91cERyaXZlcjogc3lzdGVtZC9jZ3JvdXBEcml2ZXI6IGNncm91cGZzLyIgIiRLVUJFTEVUX0NPTkZJRyIKICAgIGZpCn0KCmNvbmZpZ3VyZV9rdWJlbGV0ICIkKGNoZWNrX2N1cnJlbnRfY2dyb3VwKSIK
EOF
chmod '0755' '/opt/gardener/bin/kubelet_cgroup_driver.sh'



cat << EOF | base64 -d > '/etc/systemd/system/unit1'
W1VuaXRdCkRlc2NyaXB0aW9uPXRlc3QgY29udGVudApbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKW1NlcnZpY2VdClJlc3RhcnQ9YWx3YXlz
EOF
cat << EOF | base64 -d > '/etc/systemd/system/unit2'
W1VuaXRdCkRlc2NyaXB0aW9uPXRlc3QgY29udGVudApbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKW1NlcnZpY2VdClJlc3RhcnQ9YWx3YXlz
EOF

mkdir -p '/etc/systemd/system/unit2.d'
cat << EOF | base64 -d > '/etc/systemd/system/unit2.d/dropin'
W1NlcnZpY2VdCkVudmlyb25tZW50PSJET0NLRVJfT1BUUz0tLWxvZy1vcHQgbWF4LXNpemU9NjBtIC0tbG9nLW9wdCBtYXgtZmlsZT0zIg==
EOF
cat << EOF | base64 -d > '/etc/systemd/system/gardener-configure-cgroups.service'
W1VuaXRdCkRlc2NyaXB0aW9uPUNvbmZpZ3VyZSBjZ3JvdXAgdmVyc2lvbiBmb3IgR2FyZGVuZXIKQWZ0ZXI9Y2xvdWQtY29uZmlnLWRvd25sb2FkZXIuc2VydmljZQpCZWZvcmU9Z2FyZGVuZXItcmVzdGFydC1zeXN0ZW0uc2VydmljZSBrdWJlbGV0LnNlcnZpY2UKCltJbnN0YWxsXQpXYW50ZWRCeT1tdWx0aS11c2VyLnRhcmdldAoKW1NlcnZpY2VdClR5cGU9b25lc2hvdApFeGVjU3RhcnQ9L29wdC9nYXJkZW5lci9iaW4vY29uZmlndXJlX2Nncm91cHMuc2gKUmVtYWluQWZ0ZXJFeGl0PXRydWUKU3RhbmRhcmRPdXRwdXQ9am91cm5hbAo=
EOF
cat << EOF | base64 -d > '/etc/systemd/system/gardener-configure-lsm.service'
W1VuaXRdCkRlc2NyaXB0aW9uPUNvbmZpZ3VyZSBsc20gZm9yIEdhcmRlbmVyCkFmdGVyPWNsb3VkLWNvbmZpZy1kb3dubG9hZGVyLnNlcnZpY2UKQmVmb3JlPWdhcmRlbmVyLXJlc3RhcnQtc3lzdGVtLnNlcnZpY2Uga3ViZWxldC5zZXJ2aWNlCgpbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKCltTZXJ2aWNlXQpUeXBlPW9uZXNob3QKRXhlY1N0YXJ0PS9vcHQvZ2FyZGVuZXIvYmluL2NvbmZpZ3VyZV9sc20uc2gKUmVtYWluQWZ0ZXJFeGl0PXRydWUKU3RhbmRhcmRPdXRwdXQ9am91cm5hbAo=
EOF
cat << EOF | base64 -d > '/etc/systemd/system/gardener-configure-nfbackend.service'
W1VuaXRdCkRlc2NyaXB0aW9uPUNvbmZpZ3VyZSBuZXRmaWx0ZXIgYmFja2VuZCBmb3IgR2FyZGVuZXIKQWZ0ZXI9Y2xvdWQtY29uZmlnLWRvd25sb2FkZXIuc2VydmljZQpCZWZvcmU9Z2FyZGVuZXItcmVzdGFydC1zeXN0ZW0uc2VydmljZSBrdWJlbGV0LnNlcnZpY2UKCltJbnN0YWxsXQpXYW50ZWRCeT1tdWx0aS11c2VyLnRhcmdldAoKW1NlcnZpY2VdClR5cGU9b25lc2hvdApFeGVjU3RhcnQ9L29wdC9nYXJkZW5lci9iaW4vY29uZmlndXJlX25ldGZpbHRlcl9iYWNrZW5kLnNoClJlbWFpbkFmdGVyRXhpdD10cnVlClN0YW5kYXJkT3V0cHV0PWpvdXJuYWwK
EOF
cat << EOF | base64 -d > '/etc/systemd/system/gardener-restart-system.service'
W1VuaXRdCkRlc2NyaXB0aW9uPU9wdGlvbmFsbHkgcmVzdGFydCBzeXN0ZW0gdG8gYXBwbHkgR2FyZGVuZXIgc3BlY2lmaWMgT1MgY29uZmlndXJhdGlvbgpEb2N1bWVudGF0aW9uPWh0dHBzOi8vZ2l0aHViLmNvbS9nYXJkZW5saW51eC9nYXJkZW5saW51eC9kb2NzL2dhcmRlbmVyLWtlcm5lbC1yZXN0YXJ0Lm1kCkFmdGVyPWdhcmRlbmVyLWNvbmZpZ3VyZS1jZ3JvdXBzLnNlcnZpY2UgZ2FyZGVybmVyLWNvbmZpZ3VyZS1sc20uc2VydmljZQpCZWZvcmU9a3ViZWxldC5zZXJ2aWNlCgpbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKCltTZXJ2aWNlXQpUeXBlPW9uZXNob3QKRXhlY1N0YXJ0PS9vcHQvZ2FyZGVuZXIvYmluL3Jlc3RhcnRfc3lzdGVtLnNoClJlbWFpbkFmdGVyRXhpdD10cnVlClN0YW5kYXJkT3V0cHV0PWpvdXJuYWwK
EOF


mkdir -p '/etc/systemd/system/containerd.service.d'
cat << EOF | base64 -d > '/etc/systemd/system/containerd.service.d/10-configure-cgroup-driver.conf'
W1NlcnZpY2VdCkV4ZWNTdGFydFByZT0vb3B0L2dhcmRlbmVyL2Jpbi9jb250YWluZXJkX2Nncm91cF9kcml2ZXIuc2gK
EOF

mkdir -p '/etc/systemd/system/kubelet.service.d'
cat << EOF | base64 -d > '/etc/systemd/system/kubelet.service.d/10-configure-cgroup-driver.conf'
W1NlcnZpY2VdCkV4ZWNTdGFydFByZT0vb3B0L2dhcmRlbmVyL2Jpbi9rdWJlbGV0X2Nncm91cF9kcml2ZXIuc2gK
EOF

grep -sq "^nfsd$" /etc/modules || echo "nfsd" >>/etc/modules
modprobe nfsd
nslookup $(hostname) || systemctl restart systemd-networkd

systemctl daemon-reload
systemctl enable gardener-configure-cgroups.service && systemctl restart gardener-configure-cgroups.service
systemctl enable gardener-configure-lsm.service && systemctl restart gardener-configure-lsm.service
systemctl enable gardener-configure-nfbackend.service && systemctl restart gardener-configure-nfbackend.service
systemctl enable gardener-restart-system.service && systemctl restart gardener-restart-system.service