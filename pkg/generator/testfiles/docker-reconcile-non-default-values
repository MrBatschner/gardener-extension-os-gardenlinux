#!/bin/bash

mkdir -p '/var/lib/kubelet'
cat << EOF | base64 -d > '/var/lib/kubelet/ca.crt'
c2VjcmV0UmVmOgpuYW1lOiBkZWZhdWx0LXRva2VuLWQ5bnpsCmRhdGFLZXk6IHRva2Vu
EOF
chmod '0644' '/var/lib/kubelet/ca.crt'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/configure_cgroups.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKQ0dST1VQX0NNRExJTkU9Ii9ldGMva2VybmVsL2NtZGxpbmUuZC84MC1jZ3JvdXAuY2ZnIgoKc291cmNlICIkKGRpcm5hbWUgJDApL2dfZnVuY3Rpb25zLnNoIgoKIyB0aGVzZSBhcmUgdGhlIGNncm91cCB2ZXJzaW9ucyB3ZSB3YW50IHRvIGhhdmUgY29uZmlndXJlZCBhbmQgdGhhdCBhcmUgYWN0dWFsbHkgcnVubmluZyBvbiB0aGUgc3lzdGVtCmRlc2lyZWRfY2dyb3VwPSJ2MSIKY3VycmVudF9jZ3JvdXA9JChjaGVja19jdXJyZW50X2Nncm91cCkKCiMgY2hlY2sgaWYgdGhlIHN5c3RlbSBuZWVkcyB0byBiZSByZWNvbmZpZ3VyZWQKaWYgW1sgIiRkZXNpcmVkX2Nncm91cCIgPT0gIiR7Y3VycmVudF9jZ3JvdXAlJSAqfSIgXV07IHRoZW4KICAgIGVjaG8gInN5c3RlbSBhbHJlYWR5IHJ1bm5pbmcgd2l0aCBjZ3JvdXAgJGRlc2lyZWRfY2dyb3VwIC0gZXhpdGluZyIKICAgIGV4aXQgMApmaQoKIyByZWNvbmZpZ3VyZSB0aGUgYm9vdGxvYWRlciB0byBpbmNsdWRlIHVuaWZpZWQgaGllcmFyY2h5IChvciBub3QpCmlmIFtbICIkZGVzaXJlZF9jZ3JvdXAiID09ICJ2MSIgXV07IHRoZW4KICAgIGVjaG8gImNvbmZpZ3VyaW5nIHN5c3RlbSB0byB1c2UgY2dyb3VwIHYxIgogICAgY2F0IDw8ICdfX0VPRicgPiAiJENHUk9VUF9DTURMSU5FIgojIERpc2FibGUgY2dyb3VwIHYyIHN1cHBvcnQKQ01ETElORV9MSU5VWD0iJENNRExJTkVfTElOVVggc3lzdGVtZC51bmlmaWVkX2Nncm91cF9oaWVyYXJjaHk9MCIKX19FT0YKCmVsaWYgW1sgIiRkZXNpcmVkX2Nncm91cCIgPT0gInYyIiBdXTsgdGhlbgogICAgZWNobyAiY29uZmlndXJpbmcgc3lzdGVtIHRvIHVzZSBjZ3JvdXAgdjIiCiAgICBjYXQgPDwgJ19fRU9GJyA+ICIkQ0dST1VQX0NNRExJTkUiCiMgRW5hYmxlIGNncm91cCB2MiBzdXBwb3J0CkNNRExJTkVfTElOVVg9IiRDTURMSU5FX0xJTlVYIHN5c3RlbWQudW5pZmllZF9jZ3JvdXBfaGllcmFyY2h5PTEiCl9fRU9GCgplbHNlCiAgICBlY2hvICJkZXNpcmVkIGNncm91cCB2ZXJzaW9uICRkZXNpcmVkX2Nncm91cCBjYW5ub3QgYmUgZW5hYmxlZCwgbGVhdmluZyBzeXN0ZW0gd2l0aCAkY3VycmVudF9jZ3JvdXAiCiAgICBleGl0IDEKZmkKCiMgdXBkYXRlIGJvb3Rsb2FkZXIKL3Vzci9sb2NhbC9zYmluL3VwZGF0ZS1zeXNsaW51eAoKIyB0cmlnZ2VyIGEgcmVib290IGJ5IHBsYWNpbmcgYSBjb250cm9sIGZpbGUgaW50byAvdmFyL3J1biB3aGljaCB3aWxsIGJlIHBpY2tlZCB1cCBieQojIGdhcmRlbmVyLXJlc3RhcnQtc3lzdGVtLnNlcnZpY2UKZWNobyAic2NoZWR1bGluZyBhIHJlYm9vdCB0byBhY3RpdmF0ZSBjZ3JvdXAgJGRlc2lyZWRfY2dyb3VwIgpta2RpciAtcCAkKGRpcm5hbWUgJFJFU1RBUlRfQ09OVFJPTF9GSUxFKQp0b3VjaCAkUkVTVEFSVF9DT05UUk9MX0ZJTEUK
EOF
chmod '0755' '/opt/gardener/bin/configure_cgroups.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/configure_lsm.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKTFNNX0NNRExJTkU9Ii9ldGMva2VybmVsL2NtZGxpbmUuZC85MC1sc20uY2ZnIgoKc291cmNlICIkKGRpcm5hbWUgJDApL2dfZnVuY3Rpb25zLnNoIgoKZGVzaXJlZF9sc209U0VMaW51eApjdXJyZW50X2xzbT0kKGNoZWNrX2N1cnJlbnRfbHNtKQoKaWYgW1sgIiRkZXNpcmVkX2xzbSIgPT0gIkFwcEFybW9yIiBdXTsgdGhlbgogICAgZWNobyAiY29uZmlndXJpbmcgc3lzdGVtIHRvIHVzZSBBcHBBcm1vciBhcyBsc20iCiAgICBjYXQgPDwgJ19fRU9GJyA+ICIkTFNNX0NNRExJTkUiCiMgU2V0IEFwcEFybW9yIGFzIExpbnV4IFNlY3VyaXR5IE1vZHVsZQpDTURMSU5FX0xJTlVYPSIkQ01ETElORV9MSU5VWCBzZWN1cml0eT1hcHBhcm1vciIKX19FT0YKCmVsaWYgW1sgIiRkZXNpcmVkX2xzbSIgPT0gIlNFTGludXgiIF1dOyB0aGVuCiAgICBlY2hvICJjb25maWd1cmluZyBzeXN0ZW0gdG8gdXNlIFNFTGludXggYXMgbHNtIgogICAgY2F0IDw8ICdfX0VPRicgPiAiJExTTV9DTURMSU5FIgojIFNldCBTRUxpbnV4IGFzIExpbnV4IFNlY3VyaXR5IE1vZHVsZQpDTURMSU5FX0xJTlVYPSIkQ01ETElORV9MSU5VWCBzZWN1cml0eT1zZWxpbnV4IgpfX0VPRgoKZWxzZQogICAgZWNobyAiZGVzaXJlZCBsc20gJGRlc2lyZWRfbHNtIGNhbm5vdCBiZSBlbmFibGVkLCBsZWF2aW5nIHN5c3RlbSB3aXRoICRjdXJyZW50X2xzbSIKICAgIGV4aXQgMQpmaQoKIyB1cGRhdGUgYm9vdGxvYWRlcgovdXNyL2xvY2FsL3NiaW4vdXBkYXRlLXN5c2xpbnV4CgppZiBbWyAiJGRlc2lyZWRfbHNtIiA9PSAiJHtjdXJyZW50X2xzbX0iIF1dOyB0aGVuCiAgICBlY2hvICJzeXN0ZW0gYWxyZWFkeSBydW5uaW5nIHdpdGggJGRlc2lyZWRfbHNtIC0gbm90IHRyaWdnZXJpbmcgYSByZWJvb3QiCiAgICBleGl0IDAKZWxzZQogICAgZWNobyAic2NoZWR1bGluZyBhIHJlYm9vdCB0byBMaW51eCBzZWN1cml0eSBtb2R1bGUgJGRlc2lyZWRfbHNtIgogICAgbWtkaXIgLXAgJChkaXJuYW1lICRSRVNUQVJUX0NPTlRST0xfRklMRSkKICAgIHRvdWNoICRSRVNUQVJUX0NPTlRST0xfRklMRQpmaQo=
EOF
chmod '0755' '/opt/gardener/bin/configure_lsm.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/restart_system.sh'
IyEvYmluL2Jhc2gKCnNldCAtRXVvIHBpcGVmYWlsCgpzb3VyY2UgIiQoZGlybmFtZSAkMCkvZ19mdW5jdGlvbnMuc2giCgppZiBzeXN0ZW1jdGwgc3RhdHVzIGt1YmVsZXQuc2VydmljZTsgdGhlbgogICAgZWNobyAia3ViZWxldCBpcyBydW5uaW5nLCBub3QgcmVzdGFydGluZyB0aGUga2VybmVsIiA+JjIKICAgIGV4aXQgMApmaQoKaWYgWyAhIC1lICIkUkVTVEFSVF9DT05UUk9MX0ZJTEUiIF07IHRoZW4KICAgIGVjaG8gInJlc3RhcnQgb2Yga2VybmVsIG5vdCByZXF1ZXN0ZWQsIGV4aXRpbmcgaGFwcGlseSIKICAgIGV4aXQgMApmaQoKc2V0IC1lCgprZXJuZWw9Ii9ib290L3ZtbGludXotJCh1bmFtZSAtcikiCmluaXRyZD0iL2Jvb3QvaW5pdHJkLmltZy0kKHVuYW1lIC1yKSIKY21kbGluZT0iL2V0Yy9rZXJuZWwvY21kbGluZSIKCmlmIFsgISAtZSAiJGtlcm5lbCIgXTsgdGhlbgogICAgZWNobyAia2VybmVsIGNvdWxkIG5vdCBiZSBmb3VuZCBhdCAka2VybmVsIiA+JjIKICAgIGV4aXQgMQpmaQoKaWYgWyAhIC1lICIkaW5pdHJkIiBdOyB0aGVuCiAgICBlY2hvICJrZXJuZWwgY291bGQgbm90IGJlIGZvdW5kIGF0ICRpbml0cmQiID4mMgogICAgZXhpdCAyCmZpCgppZiBbICEgLWUgIiRjbWRsaW5lIiBdOyB0aGVuCiAgICBlY2hvICJrZXJuZWwgY29tbWFuZCBsaW5lIGNvdWxkIG5vdCBiZSBmb3VuZCBhdCAkY21kbGluZSIgPiYyCiAgICBleGl0IDMKZmkKCiMgd2Ugc2VlbSB0byBoYXZlIGV2ZXJ5dGhpbmcgc28gbGV0cyByZXN0YXJ0IHRoZSBrZXJuZWwgd2l0aCBrZXhlYwpybSAtZiAiJFJFU1RBUlRfQ09OVFJPTF9GSUxFIgoKIyBrZXhlYyB3b3VsZCBiZSBuaWNlIGJlY2F1c2UgaXQgaXMgZmFzdCBidXQgYXQgdGhlIG1vbWVudCwgaXQgc2VlbXMgdG8gYmUgZmFpbGluZyBvbiBzb21lCiMgc3lzdGVtcyBkdWUgdG8gaW5pdHJkIHNpemUgb3IgYWNwaSBvciBzb21ldGhpbmcgZWxzZSwgc28gY29tbWVudGluZyBpdCBvdXQgZm9yIG5vdwoja2V4ZWMgLWEgLS1pbml0cmQ9IiRpbml0cmQiIC0tY29tbWFuZC1saW5lPSJcIiQoY2F0ICIkY21kbGluZSIpXCIiICIka2VybmVsIgoKIyBhbmQgcmVseSBvbiBnb29kIG9sZCBzaHV0ZG93biAoZXZlbiB0aG91Z2ggdGhhdCBtYXkgdGFrZSBhZ2VzIG9uIHN5c3RlbXMgdy8gbG90cyBvZiByYW0pCnNodXRkb3duIC0tbm8td2FsbCAtciBub3cK
EOF
chmod '0755' '/opt/gardener/bin/restart_system.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/g_functions.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKUkVTVEFSVF9DT05UUk9MX0ZJTEU9Ii92YXIvcnVuL2dhcmRlbmVyL3Jlc3RhcnQtcmVxdWlyZWQiCgpmdW5jdGlvbiBnZXRfZnNfb2ZfZGlyZWN0b3J5IHsKICAgIFsgLXogIiQxIiAtbyAhIC1kICIkMSIgXSAmJiByZXR1cm4KICAgIGVjaG8gLW4gIiQoc3RhdCAtYyAlVCAtZiAiJDEiKSIKfQoKZnVuY3Rpb24gY2hlY2tfY3VycmVudF9jZ3JvdXAgewogICAgIyBkZXRlcm1pbmluZyBpZiB0aGUgc3lzdGVtIGlzIHJ1bm5pbmcgY2dyb3VwdjEgb3IgY2dyb3VwdjIKICAgICMgdXNpbmcgc3lzdGVtZCBhcHByb2FjaCBhcyBpbgogICAgIyBodHRwczovL2dpdGh1Yi5jb20vc3lzdGVtZC9zeXN0ZW1kL2Jsb2IvZDZkNDUwMDc0ZmY3NzI5ZDQzNDc2ODA0ZTBlMTljMDQ5YzAzMTQxZC9zcmMvYmFzaWMvY2dyb3VwLXV0aWwuYyNMMjEwNS1MMjE0OQoKICAgIENHUk9VUF9JRD0iY2dyb3VwZnMiCiAgICBDR1JPVVAyX0lEPSJjZ3JvdXAyZnMiCiAgICBUTVBGU19JRD0idG1wZnMiCgogICAgY2dyb3VwX2Rpcl9mcz0iJChnZXRfZnNfb2ZfZGlyZWN0b3J5IC9zeXMvZnMvY2dyb3VwKSIKCiAgICBpZiBbWyAiJGNncm91cF9kaXJfZnMiID09ICIkQ0dST1VQMl9JRCIgXV07IHRoZW4KICAgICAgICBlY2hvICJ2MiIKICAgICAgICByZXR1cm4KICAgIGVsaWYgW1sgIiRjZ3JvdXBfZGlyX2ZzIiA9PSAiJFRNUEZTX0lEIiBdXTsgdGhlbgogICAgICAgIGlmIFtbICIkKGdldF9mc19vZl9kaXJlY3RvcnkgL3N5cy9mcy9jZ3JvdXAvdW5pZmllZCkiID09ICIkQ0dST1VQMl9JRCIgXV07IHRoZW4KICAgICAgICAgICAgZWNobyAidjEgKGNncm91cHYyc3lzdGVtZCkiCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZpCiAgICAgICAgaWYgW1sgIiQoZ2V0X2ZzX29mX2RpcmVjdG9yeSAvc3lzL2ZzL2Nncm91cC9zeXN0ZW1kKSIgPT0gIiRDR1JPVVAyX0lEIiBdXTsgdGhlbgogICAgICAgICAgICBlY2hvICJ2MSAoY2dyb3VwdjJzeXN0ZW1kMjMyKSIKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZmkKICAgICAgICBpZiBbWyAiJChnZXRfZnNfb2ZfZGlyZWN0b3J5IC9zeXMvZnMvY2dyb3VwL3N5c3RlbWQpIiA9PSAiJENHUk9VUF9JRCIgXV07IHRoZW4KICAgICAgICAgICAgZWNobyAidjEiCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGZpCiAgICBmaQogICAgIyBpZiB3ZSBjYW1lIHRoaXMgZmFyIGRlc3BpdGUgYWxsIHRob3NlIHJldHVybnMsIGl0IG1lYW5zIHNvbWV0aGluZyB3ZW50IHdyb25nCiAgICBlY2hvICJmYWlsZWQgdG8gZGV0ZXJtaW5lIGNncm91cCB2ZXJzaW9uIGZvciB0aGlzIHN5c3RlbSIgPiYyCiAgICBleGl0IDEKfQoKZnVuY3Rpb24gY2hlY2tfY3VycmVudF9sc20gewogICAgaWYgZ3JlcCAtcSBzZWxpbnV4IC9zeXMva2VybmVsL3NlY3VyaXR5L2xzbTsgdGhlbgogICAgICAgIGVjaG8gU0VMaW51eAogICAgZWxpZiBncmVwIC1xIGFwcGFybW9yIC9zeXMva2VybmVsL3NlY3VyaXR5L2xzbTsgdGhlbgogICAgICAgIGVjaG8gQXBwQXJtb3IKICAgIGVsc2UKICAgICAgICBlY2hvIG5vbmUKICAgIGZpCn0K
EOF
chmod '0755' '/opt/gardener/bin/g_functions.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/containerd_cgroup_driver.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKc291cmNlICIkKGRpcm5hbWUgJDApL2dfZnVuY3Rpb25zLnNoIgoKIyByZWNvbmZpZ3VyZXMgY29udGFpbmVyZCB0byB1c2Ugc3lzdGVtZCBhcyBhIGNncm91cCBkcml2ZXIgb24gY2dyb3VwIHYyIGVuYWJsZWQgc3lzdGVtcwpmdW5jdGlvbiBjb25maWd1cmVfY29udGFpbmVyZCB7CiAgICBkZXNpcmVkX2Nncm91cD0kMQogICAgQ09OVEFJTkVSRF9DT05GSUc9Ii9ldGMvY29udGFpbmVyZC9jb25maWcudG9tbCIKCiAgICBpZiBbICEgLXMgIiRDT05UQUlORVJEX0NPTkZJRyIgXTsgdGhlbgogICAgICAgIGVjaG8gIiRDT05UQUlORVJEX0NPTkZJRyBkb2VzIG5vdCBleGlzdCIgPiYyCiAgICAgICAgcmV0dXJuCiAgICBmaQoKICAgIGlmIFtbICIkZGVzaXJlZF9jZ3JvdXAiID09ICJ2MiIgXV07IHRoZW4KICAgICAgICBlY2hvICJDb25maWd1cmluZyBjb250YWluZXJkIGNncm91cCBkcml2ZXIgdG8gc3lzdGVtZCIKICAgICAgICBzZWQgLWkgInMvU3lzdGVtZENncm91cCAqPSAqZmFsc2UvU3lzdGVtZENncm91cCA9IHRydWUvIiAiJENPTlRBSU5FUkRfQ09ORklHIgogICAgZWxzZQogICAgICAgIGVjaG8gIkNvbmZpZ3VyaW5nIGNvbnRhaW5lcmQgY2dyb3VwIGRyaXZlciB0byBjZ3JvdXBmcyIKICAgICAgICBzZWQgLWkgInMvU3lzdGVtZENncm91cCAqPSAqdHJ1ZS9TeXN0ZW1kQ2dyb3VwID0gZmFsc2UvIiAiJENPTlRBSU5FUkRfQ09ORklHIgogICAgZmkKfQoKY29uZmlndXJlX2NvbnRhaW5lcmQgIiQoY2hlY2tfY3VycmVudF9jZ3JvdXApIgo=
EOF
chmod '0755' '/opt/gardener/bin/containerd_cgroup_driver.sh'

mkdir -p '/opt/gardener/bin'
cat << EOF | base64 -d > '/opt/gardener/bin/kubelet_cgroup_driver.sh'
IyEvYmluL2Jhc2gKCnNldCAtRWV1byBwaXBlZmFpbAoKc291cmNlICIkKGRpcm5hbWUgJDApL2dfZnVuY3Rpb25zLnNoIgoKIyByZWNvbmZpZ3VyZSB0aGUga3ViZWxldCB0byB1c2Ugc3lzdGVtZCBhcyBhIGNncm91cCBkcml2ZXIgb24gY2dyb3VwIHYyIGVuYWJsZWQgc3lzdGVtcwpmdW5jdGlvbiBjb25maWd1cmVfa3ViZWxldCB7CiAgICBkZXNpcmVkX2Nncm91cD0kMQogICAgS1VCRUxFVF9DT05GSUc9Ii92YXIvbGliL2t1YmVsZXQvY29uZmlnL2t1YmVsZXQiCgogICAgaWYgWyAhIC1zICIkS1VCRUxFVF9DT05GSUciIF07IHRoZW4KICAgICAgICBlY2hvICIkS1VCRUxFVF9DT05GSUcgZG9lcyBub3QgZXhpc3QiID4mMgogICAgICAgIHJldHVybgogICAgZmkKCiAgICBpZiBbWyAiJGRlc2lyZWRfY2dyb3VwIiA9PSAidjIiIF1dOyB0aGVuCiAgICAgICAgZWNobyAiQ29uZmlndXJpbmcga3ViZWxldCB0byB1c2Ugc3lzdGVtZCBhcyBjZ3JvdXAgZHJpdmVyIgogICAgICAgIHNlZCAtaSAicy9jZ3JvdXBEcml2ZXI6IGNncm91cGZzL2Nncm91cERyaXZlcjogc3lzdGVtZC8iICIkS1VCRUxFVF9DT05GSUciCiAgICBlbHNlCiAgICAgICAgZWNobyAiQ29uZmlndXJpbmcga3ViZWxldCB0byB1c2UgY2dyb3VwZnMgYXMgY2dyb3VwIGRyaXZlciIKICAgICAgICBzZWQgLWkgInMvY2dyb3VwRHJpdmVyOiBzeXN0ZW1kL2Nncm91cERyaXZlcjogY2dyb3VwZnMvIiAiJEtVQkVMRVRfQ09ORklHIgogICAgZmkKfQoKY29uZmlndXJlX2t1YmVsZXQgIiQoY2hlY2tfY3VycmVudF9jZ3JvdXApIgo=
EOF
chmod '0755' '/opt/gardener/bin/kubelet_cgroup_driver.sh'



cat << EOF | base64 -d > '/etc/systemd/system/unit1'
W1VuaXRdCkRlc2NyaXB0aW9uPXRlc3QgY29udGVudApbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKW1NlcnZpY2VdClJlc3RhcnQ9YWx3YXlz
EOF
cat << EOF | base64 -d > '/etc/systemd/system/unit2'
W1VuaXRdCkRlc2NyaXB0aW9uPXRlc3QgY29udGVudApbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKW1NlcnZpY2VdClJlc3RhcnQ9YWx3YXlz
EOF

mkdir -p '/etc/systemd/system/unit2.d'
cat << EOF | base64 -d > '/etc/systemd/system/unit2.d/dropin'
W1NlcnZpY2VdCkVudmlyb25tZW50PSJET0NLRVJfT1BUUz0tLWxvZy1vcHQgbWF4LXNpemU9NjBtIC0tbG9nLW9wdCBtYXgtZmlsZT0zIg==
EOF
cat << EOF | base64 -d > '/etc/systemd/system/gardener-configure-cgroups.service'
W1VuaXRdCkRlc2NyaXB0aW9uPUNvbmZpZ3VyZSBjZ3JvdXAgdmVyc2lvbiBmb3IgR2FyZGVuZXIKQWZ0ZXI9Y2xvdWQtY29uZmlnLWRvd25sb2FkZXIuc2VydmljZQpCZWZvcmU9Z2FyZGVuZXItcmVzdGFydC1zeXN0ZW0uc2VydmljZSBrdWJlbGV0LnNlcnZpY2UKCltJbnN0YWxsXQpXYW50ZWRCeT1tdWx0aS11c2VyLnRhcmdldAoKW1NlcnZpY2VdClR5cGU9b25lc2hvdApFeGVjU3RhcnQ9L29wdC9nYXJkZW5lci9iaW4vY29uZmlndXJlX2Nncm91cHMuc2gKUmVtYWluQWZ0ZXJFeGl0PXRydWUKU3RhbmRhcmRPdXRwdXQ9am91cm5hbAo=
EOF
cat << EOF | base64 -d > '/etc/systemd/system/gardener-configure-lsm.service'
W1VuaXRdCkRlc2NyaXB0aW9uPUNvbmZpZ3VyZSBMU00gZm9yIEdhcmRlbmVyCkFmdGVyPWNsb3VkLWNvbmZpZy1kb3dubG9hZGVyLnNlcnZpY2UKQmVmb3JlPWdhcmRlbmVyLXJlc3RhcnQtc3lzdGVtLnNlcnZpY2Uga3ViZWxldC5zZXJ2aWNlCgpbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKCltTZXJ2aWNlXQpUeXBlPW9uZXNob3QKRXhlY1N0YXJ0PS9vcHQvZ2FyZGVuZXIvYmluL2NvbmZpZ3VyZV9sc20uc2gKUmVtYWluQWZ0ZXJFeGl0PXRydWUKU3RhbmRhcmRPdXRwdXQ9am91cm5hbAo=
EOF
cat << EOF | base64 -d > '/etc/systemd/system/gardener-restart-system.service'
W1VuaXRdCkRlc2NyaXB0aW9uPU9wdGlvbmFsbHkgcmVzdGFydCBzeXN0ZW0gdG8gYXBwbHkgR2FyZGVuZXIgc3BlY2lmaWMgT1MgY29uZmlndXJhdGlvbgpEb2N1bWVudGF0aW9uPWh0dHBzOi8vZ2l0aHViLmNvbS9nYXJkZW5saW51eC9nYXJkZW5saW51eC9kb2NzL2dhcmRlbmVyLWtlcm5lbC1yZXN0YXJ0Lm1kCkFmdGVyPWdhcmRlbmVyLWNvbmZpZ3VyZS1jZ3JvdXBzLnNlcnZpY2UgZ2FyZGVybmVyLWNvbmZpZ3VyZS1sc20uc2VydmljZQpCZWZvcmU9a3ViZWxldC5zZXJ2aWNlCgpbSW5zdGFsbF0KV2FudGVkQnk9bXVsdGktdXNlci50YXJnZXQKCltTZXJ2aWNlXQpUeXBlPW9uZXNob3QKRXhlY1N0YXJ0PS9vcHQvZ2FyZGVuZXIvYmluL3Jlc3RhcnRfc3lzdGVtLnNoClJlbWFpbkFmdGVyRXhpdD10cnVlClN0YW5kYXJkT3V0cHV0PWpvdXJuYWwK
EOF


mkdir -p '/etc/systemd/system/containerd.service.d'
cat << EOF | base64 -d > '/etc/systemd/system/containerd.service.d/10-configure-cgroup-driver.conf'
W1NlcnZpY2VdCkV4ZWNTdGFydFByZT0vb3B0L2dhcmRlbmVyL2Jpbi9jb250YWluZXJkX2Nncm91cF9kcml2ZXIuc2gK
EOF

mkdir -p '/etc/systemd/system/kubelet.service.d'
cat << EOF | base64 -d > '/etc/systemd/system/kubelet.service.d/10-configure-cgroup-driver.conf'
W1NlcnZpY2VdCkV4ZWNTdGFydFByZT0vb3B0L2dhcmRlbmVyL2Jpbi9rdWJlbGV0X2Nncm91cF9kcml2ZXIuc2gK
EOF

grep -sq "^nfsd$" /etc/modules || echo "nfsd" >>/etc/modules
modprobe nfsd
nslookup $(hostname) || systemctl restart systemd-networkd

systemctl daemon-reload
systemctl enable gardener-configure-cgroups.service && systemctl restart gardener-configure-cgroups.service
systemctl enable gardener-configure-lsm.service && systemctl restart gardener-configure-lsm.service
systemctl enable gardener-restart-system.service && systemctl restart gardener-restart-system.service